# C3PO 系统迭代一设计文档

## 文档说明

本文档描述C3PO系统迭代一（基本功能实现阶段）的后端设计。迭代一主要完成了系统的基础架构、用户认证、课程管理、作业管理、提交评分等核心功能模块。

---

## 第一部分：概要设计

### 1. 技术选型说明

#### 1.1 开发语言与框架
- **Java 17**: 采用LTS版本，提供现代语言特性
- **Spring Boot 3.5.7**: 企业级应用框架，提供自动配置和快速开发能力
- **Spring Security**: 提供认证和授权功能
- **Spring Data JPA**: 简化数据访问层开发

#### 1.2 数据存储
- **PostgreSQL**: 生产环境关系型数据库
- **H2 Database**: 开发测试环境内存数据库
- **Redis**: 缓存支持（当前配置中已引入，但暂未启用）

#### 1.3 安全认证
- **JWT (JSON Web Token)**: 基于Token的无状态认证机制
- **BCrypt**: 密码加密算法

#### 1.4 开发工具
- **Lombok**: 减少样板代码
- **Gradle**: 项目构建工具
- **Jakarta EE**: 使用Jakarta Persistence API（JPA）

#### 1.5 其他技术
- **Jackson**: JSON序列化/反序列化
- **Bean Validation**: 数据验证

### 2. 系统架构设计

#### 2.1 整体架构

系统采用经典的三层架构模式（MVC），结合Spring Boot的分层设计：

```
┌─────────────────────────────────────────────────────────┐
│                     前端层 (Frontend)                    │
│              (Vue.js / React / 移动端)                   │
└──────────────────────┬──────────────────────────────────┘
                       │ HTTP/HTTPS + JWT
┌──────────────────────┴──────────────────────────────────┐
│                  表现层 (Presentation Layer)             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │ AuthController│  │CourseController│ │AssignmentCtrl│ │
│  │ MemberCtrl   │  │ ActivityCtrl  │ │ SubmissionCtrl│  │
│  │ DashboardCtrl│  │ ApprovalCtrl  │ │  ScoreCtrl    │  │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘   │
│         │                  │                  │         │
│  ┌──────┴──────────────────┴──────────────────┴──────┐  │
│  │         GlobalExceptionHandler                    │  │
│  │         (统一异常处理)                              │  │
│  └───────────────────────────────────────────────────┘  │
└──────────────────────┬──────────────────────────────────┘
                       │
┌──────────────────────┴─────────────────────────────────┐
│                   业务逻辑层 (Service Layer)             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  AuthService │  │ CourseService│  │AssignmentSvc │  │
│  │ MemberService│  │ ActivitySvc  │  │ SubmissionSvc│  │
│  │ ApplicationSvc│ │ AttendanceSvc│  │  ScoreService│  │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  │
│         │                 │                 │          │
│  ┌──────┴─────────────────┴─────────────────┴──────┐   │
│  │         JwtService                              │   │
│  │         (JWT Token生成与验证)                     │   │
│  └─────────────────────────────────────────────────┘   │
└──────────────────────┬─────────────────────────────────┘
                       │
┌──────────────────────┴──────────────────────────────────┐
│                   数据访问层 (Data Access Layer)          │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────────┐  │
│  │UserAccountRepo│ │ CourseRepo   │  │AssignmentRepo │  │
│  │StudentProfile│  │ CourseModule │  │ SubmissionRepo│  │
│  │TeacherProfile│  │ SelectionRepo│  │  ScoreRepo    │  │
│  └──────┬───────┘  └───────┬──────┘  └────────┬──────┘  │
│         │                  │                  │         │
│  ┌──────┴──────────────────┴──────────────────┴──────┐  │
│  │         Spring Data JPA Repository                │  │
│  │         (自动生成CRUD操作)                          │  │
│  └────────────────────────────────────────────────────┘ │
└──────────────────────┬──────────────────────────────────┘
                       │
┌──────────────────────┴──────────────────────────────────┐
│                   数据持久层 (Persistence Layer)          │
│  ┌────────────────────────────────────────────────────┐  │
│  │              PostgreSQL / H2 Database              │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
```

#### 2.2 分层职责说明

**表现层 (Controller Layer)**
- 接收HTTP请求
- 参数验证（使用@Valid）
- 调用Service层处理业务逻辑
- 返回统一格式的响应（ApiResponse）
- 异常处理（通过GlobalExceptionHandler）

**业务逻辑层 (Service Layer)**
- 实现核心业务逻辑
- 事务管理（@Transactional）
- 调用Repository进行数据操作
- 业务规则验证

**数据访问层 (Repository Layer)**
- 基于Spring Data JPA
- 提供数据CRUD操作
- 支持自定义查询方法
- 自动处理实体关系

**实体层 (Entity Layer)**
- JPA实体定义
- 数据库表映射
- 实体关系定义

#### 2.3 安全架构

```
┌─────────────────────────────────────────┐
│          HTTP Request                   │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│    SecurityFilterChain                  │
│  ┌────────────────────────────────────┐ │
│  │  JwtAuthenticationFilter           │ │
│  │  - 提取JWT Token                    │ │
│  │  - 验证Token有效性                   │ │
│  │  - 设置SecurityContext              │ │
│  └────────────────────────────────────┘ │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│    @PreAuthorize 权限检查                │
│  - hasRole('STUDENT')                   │
│  - hasRole('TEACHER')                   │
│  - hasRole('ADMIN')                     │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│          Controller                     │
└─────────────────────────────────────────┘
```

### 3. 数据库设计

#### 3.1 核心实体关系

系统主要包含以下核心实体：

1. **用户相关**
   - `users` (用户账户)
   - `student_profiles` (学生档案)
   - `teacher_profiles` (教师档案)

2. **课程相关**
   - `courses` (课程)
   - `course_modules` (课程模块)
   - `course_resources` (课程资源)
   - `course_selections` (选课记录)

3. **作业相关**
   - `assignments` (作业)
   - `submissions` (提交记录)
   - `quiz_attempts` (测验尝试)
   - `scores` (成绩)

4. **社团相关**
   - `activities` (活动，当前为内存模型)
   - `members` (成员，当前为内存模型)
   - `applications` (申请，当前为内存模型)
   - `attendances` (考勤，当前为内存模型)

5. **系统相关**
   - `approval_requests` (审批请求)
   - `notifications` (通知)
   - `report_jobs` (报表任务)
   - `system_settings` (系统设置)

#### 3.2 ER图（实体关系图）

```
┌──────────────┐         ┌──────────────┐         ┌──────────────┐
│   UserAccount│         │    Course    │         │  Assignment  │
├──────────────┤         ├──────────────┤         ├──────────────┤
│ id (PK)      │         │ id (PK)      │         │ id (PK)      │
│ username     │         │ name         │         │ courseId (FK)│
│ email        │         │ semester     │         │ title        │
│ password     │         │ credit       │         │ type         │
│ role         │         │ status       │         │ deadline     │
│ status       │         │ enrollLimit  │         │ published    │
└──────┬───────┘         │ teacherId(FK)│         └──────┬───────┘
       │                 └──────┬───────┘                │
       │                        │                        │
       │ 1                      │ 1                      │ 1
       │                        │                        │
       │ N                      │ N                      │ N
┌──────┴───────┐         ┌──────┴───────┐         ┌──────┴───────┐
│StudentProfile│         │CourseSelection│        │  Submission  │
├──────────────┤         ├──────────────┤         ├──────────────┤
│ id (PK)      │         │ id (PK)      │         │ id (PK)      │
│ userId (FK)  │         │ courseId (FK)│         │ assignmentId │
│ studentNo    │         │ studentId(FK)│         │ studentId(FK)│
│ grade        │         │ status       │         │ status       │
│ major        │         │ selectedAt   │         │ score        │
│ className    │         └──────────────┘         │ submittedAt  │
└──────────────┘                                  │ feedback     │
                                                  └──────┬───────┘
                                                         │
                                                         │ 1
                                                         │
                                                         │ N
                                                  ┌──────┴───────┐
                                                  │    Score     │
                                                  ├──────────────┤
                                                  │ id (PK)      │
                                                  │ studentId(FK)│
                                                  │ courseId (FK)│
                                                  │ component    │
                                                  │ value        │
                                                  └──────────────┘
```

#### 3.3 主要数据表结构

**users (用户表)**
- `id`: UUID (主键)
- `username`: VARCHAR(64) (唯一，不可空)
- `email`: VARCHAR(128) (唯一，不可空)
- `password`: VARCHAR(255) (不可空，BCrypt加密)
- `role`: VARCHAR(32) (ENUM: STUDENT, TEACHER, ADMIN)
- `status`: VARCHAR(32) (ENUM: ACTIVE, LOCKED, DISABLED)
- `status_reason`: VARCHAR(512)
- `created_at`: TIMESTAMP
- `updated_at`: TIMESTAMP

**courses (课程表)**
- `id`: UUID (主键)
- `name`: VARCHAR(128) (不可空)
- `semester`: VARCHAR(32)
- `credit`: INTEGER
- `status`: VARCHAR(32) (ENUM: DRAFT, PENDING_REVIEW, PUBLISHED, ARCHIVED)
- `enroll_limit`: INTEGER
- `teacher_id`: UUID (外键，关联users)
- `created_at`: TIMESTAMP
- `updated_at`: TIMESTAMP

**assignments (作业表)**
- `id`: UUID (主键)
- `course_id`: UUID (外键，关联courses)
- `title`: VARCHAR(128) (不可空)
- `type`: VARCHAR(32) (ENUM: ASSIGNMENT, QUIZ, PROJECT)
- `deadline`: TIMESTAMP
- `release_at`: TIMESTAMP
- `published`: BOOLEAN
- `published_at`: TIMESTAMP
- `allow_resubmit`: BOOLEAN
- `max_resubmit`: INTEGER
- `grading_rubric`: VARCHAR(4096) (JSON格式)
- `created_at`: TIMESTAMP
- `updated_at`: TIMESTAMP

**submissions (提交表)**
- `id`: UUID (主键)
- `assignment_id`: UUID (外键，关联assignments)
- `student_id`: UUID (外键，关联users)
- `status`: VARCHAR(32) (ENUM: SUBMITTED, RESUBMITTED, GRADED, APPEALED)
- `score`: INTEGER
- `submitted_at`: TIMESTAMP
- `attachments`: TEXT[] (附件列表)
- `feedback`: VARCHAR(4096)
- `rubric_scores`: VARCHAR(2048) (JSON格式)
- `appeal_reason`: VARCHAR(2048)
- `appealed_at`: TIMESTAMP
- `grading_teacher_id`: UUID (外键，关联users)
- `resubmit_count`: INTEGER
- `created_at`: TIMESTAMP
- `updated_at`: TIMESTAMP

**course_selections (选课表)**
- `id`: UUID (主键)
- `course_id`: UUID (外键，关联courses)
- `student_id`: UUID (外键，关联users)
- `status`: VARCHAR(32) (ENUM: ENROLLED, DROPPED, PENDING_APPROVAL)
- `selected_at`: TIMESTAMP
- `created_at`: TIMESTAMP
- `updated_at`: TIMESTAMP

**approval_requests (审批请求表)**
- `id`: UUID (主键)
- `type`: VARCHAR(64) (ENUM: COURSE_PUBLISH等)
- `status`: VARCHAR(32) (ENUM: PENDING, APPROVED, REJECTED)
- `applicant_id`: UUID (外键，关联users)
- `payload`: VARCHAR(4096) (JSON格式，存储审批相关数据)
- `processed_by`: UUID (外键，关联users，审批人)
- `comment`: VARCHAR(1024) (审批意见)
- `processed_at`: TIMESTAMP
- `created_at`: TIMESTAMP
- `updated_at`: TIMESTAMP

**course_resources (课程资源表)**
- `id`: UUID (主键)
- `module_id`: UUID (外键，关联course_modules)
- `type`: VARCHAR(32) (ENUM: VIDEO, DOCUMENT, LINK, OTHER)
- `name`: VARCHAR(128) (不可空)
- `file_size`: BIGINT (文件大小，字节)
- `download_url`: VARCHAR(2048) (下载链接)
- `created_at`: TIMESTAMP
- `updated_at`: TIMESTAMP

### 4. 部署架构

#### 4.1 部署图

```
┌─────────────────────────────────────────────────────────┐
│                     客户端层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ Web Browser  │  │ Mobile App   │  │ Admin Panel  │  │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  │
└─────────┼──────────────────┼──────────────────┼──────────┘
          │                  │                  │
          │         HTTPS (443) / HTTP (8080)   │
          │                  │                  │
┌─────────┴──────────────────┴──────────────────┴──────────┐
│                   应用服务器层                             │
│  ┌────────────────────────────────────────────────────┐  │
│  │         Spring Boot Application (C3PO)             │  │
│  │  ┌──────────────────────────────────────────────┐  │  │
│  │  │  Port: 8080                                  │  │  │
│  │  │  - REST API Endpoints                        │  │  │
│  │  │  - JWT Authentication                        │  │  │
│  │  │  - Business Logic                            │  │  │
│  │  └──────────────────────────────────────────────┘  │  │
│  └────────────────────────────────────────────────────┘  │
└─────────┬────────────────────────────────────────────────┘
          │
          │ JDBC
          │
┌─────────┴────────────────────────────────────────────────┐
│                     数据存储层                             │
│  ┌────────────────────────────────────────────────────┐  │
│  │         PostgreSQL Database                        │  │
│  │  - Port: 5432                                      │  │
│  │  - 存储所有业务数据                                   │  │
│  └────────────────────────────────────────────────────┘  │
│                                                          │
│  ┌────────────────────────────────────────────────────┐  │
│  │         Redis (可选，已配置但未启用)                   │  │
│  │  - Port: 6379                                      │  │
│  │  - 缓存支持                                         │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
```

#### 4.2 环境配置

**开发环境**
- 数据库: H2 (内存数据库)
- 端口: 8080
- Profile: local

**生产环境**
- 数据库: PostgreSQL
- 端口: 8080 (可通过配置修改)
- Profile: prod

---

## 第二部分：详细设计

### 1. 系统类图

#### 1.1 核心实体类图

```
┌─────────────────────────────────────────────────────────┐
│                    BaseEntity                           │
├─────────────────────────────────────────────────────────┤
│ + id: UUID                                              │
│ + createdAt: Instant                                    │
│ + updatedAt: Instant                                    │
└─────────────────────────────────────────────────────────┘
                            ▲
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
┌───────┴──────┐  ┌─────────┴────────┐  ┌──────┴────────┐
│  UserAccount │  │     Course       │  │  Assignment   │
├──────────────┤  ├──────────────────┤  ├───────────────┤
│ + username   │  │ + name           │  │ + courseId    │
│ + email      │  │ + semester       │  │ + title       │
│ + password   │  │ + credit         │  │ + type        │
│ + role       │  │ + status         │  │ + deadline    │
│ + status     │  │ + enrollLimit    │  │ + published   │
└──────┬───────┘  │ + teacherId      │  └───────┬───────┘
       │          └────────┬─────────┘          │
       │                   │                    │
       │ 1                 │ 1                  │ 1
       │                   │                    │
       │ N                 │ N                  │ N
┌──────┴───────┐  ┌────────┴─────────┐  ┌──────┴────────┐
│StudentProfile│  │CourseSelection   │  │  Submission   │
├──────────────┤  ├──────────────────┤  ├───────────────┤
│ + userId     │  │ + courseId       │  │ + assignmentId│
│ + studentNo  │  │ + studentId      │  │ + studentId   │
│ + grade      │  │ + status         │  │ + status      │
│ + major      │  │ + selectedAt     │  │ + score       │
│ + className  │  └──────────────────┘  │ + feedback    │
└──────────────┘                        └───────────────┘
```

#### 1.2 服务层类图

```
┌─────────────────────────────────────────────────────────┐
│                    AuthService                          │
├─────────────────────────────────────────────────────────┤
│ - userAccountRepository: UserAccountRepository          │
│ - passwordEncoder: PasswordEncoder                      │
│ - authenticationManager: AuthenticationManager          │
│ - jwtService: JwtService                                │
├─────────────────────────────────────────────────────────┤
│ + register(request: RegisterRequest): AuthResponse      │
│ + login(request: LoginRequest): AuthResponse            │
│ + toProfile(userAccount: UserAccount): ProfileResponse  │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    JwtService                           │
├─────────────────────────────────────────────────────────┤
│ - secretKey: String                                     │
│ - expirationMs: Long                                    │
├─────────────────────────────────────────────────────────┤
│ + generateToken(userAccount: UserAccount): String       │
│ + extractUsername(token: String): String                │
│ + validateToken(token: String): Boolean                 │
└─────────────────────────────────────────────────────────┘
```

#### 1.3 控制器层类图

```
┌─────────────────────────────────────────────────────────┐
│                    AuthController                       │
├─────────────────────────────────────────────────────────┤
│ - authService: AuthService                              │
├─────────────────────────────────────────────────────────┤
│ + register(request: RegisterRequest): AuthResponse      │
│ + login(request: LoginRequest): AuthResponse            │
│ + profile(userAccount: UserAccount): ProfileResponse    │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    CourseController                     │
├─────────────────────────────────────────────────────────┤
│ - courseRepository: CourseRepository                    │
│ - courseSelectionRepository: CourseSelectionRepository  │
│ - assignmentRepository: AssignmentRepository            │
│ - submissionRepository: SubmissionRepository            │
├─────────────────────────────────────────────────────────┤
│ + listCourses(...): ApiResponse<List<CourseResponse>>   │
│ + getCourse(courseId: UUID): ApiResponse<CourseResponse>│
│ + createCourse(...): ApiResponse<CourseResponse>        │
│ + enrollCourse(...): ApiResponse<CourseEnrollmentResponse>│
│ + courseAnalytics(...): ApiResponse<CourseAnalyticsResponse>│
└─────────────────────────────────────────────────────────┘
```

### 2. 接口设计

#### 2.1 RESTful API 设计规范

- **基础路径**: `/api/v1`
- **认证方式**: JWT Bearer Token
- **响应格式**: 统一使用 `ApiResponse<T>` 包装
- **HTTP状态码**: 遵循RESTful规范

#### 2.2 核心接口列表

**认证相关 (`/api/v1/auth`)**
- `POST /api/v1/auth/register` - 用户注册
- `POST /api/v1/auth/login` - 用户登录
- `GET /api/v1/auth/me` - 获取当前用户信息

**课程相关 (`/api/v1/courses`)**
- `GET /api/v1/courses` - 获取课程列表（支持分页、搜索、筛选）
- `GET /api/v1/courses/{courseId}` - 获取课程详情
- `POST /api/v1/courses` - 创建课程（需TEACHER/ADMIN权限）
- `PUT /api/v1/courses/{courseId}` - 更新课程（需TEACHER/ADMIN权限）
- `POST /api/v1/courses/{courseId}/publish` - 发布课程（需TEACHER/ADMIN权限）
- `POST /api/v1/courses/{courseId}/enroll` - 选课（需STUDENT权限）
- `DELETE /api/v1/courses/{courseId}/enroll` - 退课（需STUDENT权限）
- `GET /api/v1/courses/{courseId}/analytics/overview` - 课程分析数据

**作业相关 (`/api/v1/assignments`)**
- `GET /api/v1/assignments` - 获取作业列表
- `GET /api/v1/assignments/{assignmentId}` - 获取作业详情
- `POST /api/v1/assignments` - 创建作业（需TEACHER/ADMIN权限）
- `PUT /api/v1/assignments/{assignmentId}` - 更新作业（需TEACHER/ADMIN权限）
- `DELETE /api/v1/assignments/{assignmentId}` - 删除作业（需TEACHER/ADMIN权限）

**提交相关 (`/api/v1/submissions`)**
- `GET /api/v1/submissions` - 获取提交列表
- `GET /api/v1/submissions/{submissionId}` - 获取提交详情
- `POST /api/v1/submissions` - 创建提交（需STUDENT权限）
- `PUT /api/v1/submissions/{submissionId}` - 更新提交（需STUDENT权限）
- `PUT /api/v1/submissions/{submissionId}/grade` - 评分（需TEACHER/ADMIN权限）

**审批相关 (`/api/v1/approvals`)**
- `GET /api/v1/approvals` - 获取审批列表
- `GET /api/v1/approvals/{approvalId}` - 获取审批详情
- `PUT /api/v1/approvals/{approvalId}/decision` - 审批决策（需ADMIN权限）

**社团相关**
- `/api/v1/activities` - 活动管理接口
- `/api/v1/members` - 成员管理接口
- `/api/v1/applications` - 申请管理接口
- `/api/v1/dashboard` - 仪表板数据接口

**其他功能**
- `/api/v1/notifications` - 通知管理接口
- `/api/v1/jobs/reports` - 报表任务接口
- `/api/v1/system/settings` - 系统设置接口

#### 2.3 统一响应格式

```java
ApiResponse<T> {
    String traceId;      // 请求追踪ID
    boolean success;     // 是否成功
    T data;              // 响应数据
    PageMeta meta;       // 分页信息（可选）
    Object error;        // 错误信息（可选）
}
```

**成功响应示例**:
```json
{
  "traceId": "550e8400-e29b-41d4-a716-446655440000",
  "success": true,
  "data": { ... },
  "meta": null,
  "error": null
}
```

**分页响应示例**:
```json
{
  "traceId": "550e8400-e29b-41d4-a716-446655440000",
  "success": true,
  "data": [ ... ],
  "meta": {
    "page": 1,
    "pageSize": 20,
    "total": 100,
    "sort": "createdAt,desc"
  },
  "error": null
}
```

**错误响应示例**:
```json
{
  "traceId": "550e8400-e29b-41d4-a716-446655440000",
  "success": false,
  "data": null,
  "meta": null,
  "error": {
    "message": "错误信息描述",
    "code": "ERROR_CODE"
  }
}
```

### 3. 重要功能流程设计

#### 3.1 用户登录流程（顺序图）

```
用户          前端           AuthController    AuthService    JwtService    UserAccountRepository
 │             │                  │                │              │                  │
 │  POST /login│                  │                │              │                  │
 │────────────>│                  │                │              │                  │
 │             │  POST /login     │                │              │                  │
 │             │─────────────────>│                │              │                  │
 │             │                  │  login()       │              │                  │
 │             │                  │───────────────>│              │                  │
 │             │                  │                │  findByUsername()              │
 │             │                  │                │───────────────────────────────>│
 │             │                  │                │              │  UserAccount    │
 │             │                  │                │<───────────────────────────────│
 │             │                  │                │  authenticate()                │
 │             │                  │                │───────────────>│              │
 │             │                  │                │              │                │
 │             │                  │                │  generateToken()              │
 │             │                  │                │──────────────>│              │
 │             │                  │                │              │  Token        │
 │             │                  │                │<──────────────│              │
 │             │                  │  AuthResponse  │              │                │
 │             │                  │<───────────────│              │                │
 │             │  AuthResponse    │                │              │                │
 │<────────────│<─────────────────│                │              │                │
```

#### 3.2 课程选课流程（顺序图）

```
学生          前端           CourseController  CourseRepository  CourseSelectionRepository
 │             │                  │                    │                    │
 │  POST /enroll│                  │                    │                    │
 │────────────>│                  │                    │                    │
 │             │  POST /enroll    │                    │                    │
 │             │─────────────────>│                    │                    │
 │             │                  │  findById()        │                    │
 │             │                  │───────────────────>│                    │
 │             │                  │                    │  Course            │
 │             │                  │<───────────────────│                    │
 │             │                  │  findByCourseIdAndStudentId()           │
 │             │                  │────────────────────────────────────────>│
 │             │                  │                    │  CourseSelection   │
 │             │                  │<────────────────────────────────────────│
 │             │                  │  countByCourseIdAndStatus()             │
 │             │                  │────────────────────────────────────────>│
 │             │                  │                    │  Count             │
 │             │                  │<────────────────────────────────────────│
 │             │                  │  save()            │                    │
 │             │                  │────────────────────────────────────────>│
 │             │                  │                    │  Saved Selection   │
 │             │                  │<────────────────────────────────────────│
 │             │  EnrollmentResponse│                  │                    │
 │<────────────│<─────────────────│                    │                    │
```

#### 3.3 作业提交与评分流程（协作图）

```
┌──────┐      ┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│学生  │      │SubmissionCtrl│      │SubmissionRepo│      │AssignmentRepo│
└──┬───┘      └──────┬───────┘      └──────┬───────┘      └──────┬───────┘
   │                 │                      │                      │
   │ 1. POST /submit │                      │                      │
   │────────────────>│                      │                      │
   │                 │ 2. findById()        │                      │
   │                 │────────────────────────────────────────────>│
   │                 │                      │                      │
   │                 │ 3. createSubmission()│                      │
   │                 │─────────────────────>│                      │
   │                 │                      │ 4. save()            │
   │                 │                      │─────────────────────>│
   │                 │                      │                      │
   │                 │ 5. Submission        │                      │
   │                 │<─────────────────────│                      │
   │                 │                      │                      │
   │ 6. Response     │                      │                      │
   │<────────────────│                      │                      │
   │                 │                      │                      │
   │                 │                      │                      │
┌──┴───┐      ┌──────┴───────┐      ┌──────┴───────┐      ┌──────┴───────┐
│教师  │      │SubmissionCtrl│      │SubmissionRepo│      │  ScoreRepo   │
└──┬───┘      └──────┬───────┘      └──────┬───────┘      └──────┬───────┘
   │                 │                      │                      │
   │ 7. PUT /grade   │                      │                      │
   │────────────────>│                      │                      │
   │                 │ 8. findById()        │                      │
   │                 │─────────────────────>│                      │
   │                 │                      │                      │
   │                 │ 9. updateGrade()     │                      │
   │                 │─────────────────────>│                      │
   │                 │                      │ 10. save()           │
   │                 │                      │─────────────────────>│
   │                 │                      │                      │
   │                 │ 11. createScore()    │                      │
   │                 │────────────────────────────────────────────>│
   │                 │                      │                      │
   │ 12. Response    │                      │                      │
   │<────────────────│                      │                      │
```

#### 3.4 课程状态转换（状态图）

```
                    ┌─────────────┐
                    │   DRAFT     │
                    │  (草稿)     │
                    └──────┬──────┘
                           │
                           │ 教师创建/编辑
                           │
                    ┌──────▼──────┐
                    │PENDING_REVIEW│
                    │ (待审核)     │
                    └──────┬──────┘
                           │
                           │ 管理员/审批通过
                           │
                    ┌──────▼──────┐
                    │  PUBLISHED  │
                    │  (已发布)   │
                    └──────┬──────┘
                           │
                           │ 课程结束/归档
                           │
                    ┌──────▼──────┐
                    │  ARCHIVED   │
                    │  (已归档)   │
                    └─────────────┘
```

#### 3.5 提交状态转换（状态图）

```
                    ┌─────────────┐
                    │  SUBMITTED  │
                    │  (已提交)   │
                    └──────┬──────┘
                           │
                           │ 学生重新提交
                           │
                    ┌──────▼──────┐
                    │RESUBMITTED  │
                    │ (重新提交)  │
                    └──────┬──────┘
                           │
                           │ 教师评分
                           │
                    ┌──────▼──────┐
                    │   GRADED    │
                    │  (已评分)   │
                    └──────┬──────┘
                           │
                           │ 学生对成绩有异议
                           │
                    ┌──────▼──────┐
                    │  APPEALED   │
                    │  (已申诉)   │
                    └─────────────┘
```

### 4. 安全设计

#### 4.1 认证流程

1. **用户注册/登录**
   - 密码使用BCrypt加密存储
   - 登录成功后生成JWT Token
   - Token包含用户ID、用户名、角色等信息

2. **Token验证**
   - 每个请求通过JwtAuthenticationFilter验证Token
   - Token过期或无效返回401 Unauthorized
   - 验证通过后设置SecurityContext

3. **权限控制**
   - 使用@PreAuthorize注解进行方法级权限控制
   - 支持角色检查：STUDENT, TEACHER, ADMIN
   - 支持资源级权限检查（如：只能修改自己的课程）

#### 4.2 数据安全

- 密码加密：BCrypt算法
- SQL注入防护：使用JPA参数化查询
- XSS防护：输入验证和输出转义
- CSRF防护：RESTful API无状态设计，已禁用CSRF

---

## 总结

迭代一完成了C3PO系统的基础架构和核心功能模块，包括：

1. **基础架构**：Spring Boot三层架构、JWT认证、统一异常处理
2. **用户管理**：用户注册、登录、权限管理
3. **课程管理**：课程CRUD、发布、选课、退课
4. **作业管理**：作业创建、发布、提交、评分
5. **数据分析**：课程分析、成绩统计

系统采用现代化的技术栈，具有良好的可扩展性和维护性。后续迭代将继续完善功能，优化性能，增强用户体验。

---

**文档版本**: v1.0  
**编写日期**: 2024年  
**适用迭代**: 迭代一（基本功能实现阶段）

